<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="All-forks header and body syncing."><meta name="keywords" content="rust, rustlang, rust-lang, all_forks"><title>smoldot::sync::all_forks - Rust</title><link rel="stylesheet" type="text/css" href="../../../normalize.css"><link rel="stylesheet" type="text/css" href="../../../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" type="text/css" href="../../../light.css"  id="themeStyle"><link rel="stylesheet" type="text/css" href="../../../dark.css" disabled ><link rel="stylesheet" type="text/css" href="../../../ayu.css" disabled ><script id="default-settings"></script><script src="../../../storage.js"></script><script src="../../../crates.js"></script><noscript><link rel="stylesheet" href="../../../noscript.css"></noscript><link rel="icon" type="image/svg+xml" href="../../../favicon.svg">
<link rel="alternate icon" type="image/png" href="../../../favicon-16x16.png">
<link rel="alternate icon" type="image/png" href="../../../favicon-32x32.png"><style type="text/css">#crate-search{background-image:url("../../../down-arrow.svg");}</style></head><body class="rustdoc mod"><!--[if lte IE 8]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="sidebar"><div class="sidebar-menu" role="button">&#9776;</div><a href='../../../smoldot/index.html'><div class='logo-container rust-logo'><img src='../../../rust-logo.png' alt='logo'></div></a><p class="location">Module all_forks</p><div class="sidebar-elems"><div class="block items"><ul><li><a href="#structs">Structs</a></li><li><a href="#enums">Enums</a></li></ul></div><p class="location"><a href="../../index.html">smoldot</a>::<wbr><a href="../index.html">sync</a></p><div id="sidebar-vars" data-name="all_forks" data-ty="mod" data-relpath="../"></div><script defer src="../sidebar-items.js"></script></div></nav><div class="theme-picker"><button id="theme-picker" aria-label="Pick another theme!" aria-haspopup="menu"><img src="../../../brush.svg" width="18" height="18" alt="Pick another theme!"></button><div id="theme-choices" role="menu"></div></div><script src="../../../theme.js"></script><nav class="sub"><form class="search-form"><div class="search-container"><div><select id="crate-search"><option value="All crates">All crates</option></select><input class="search-input" name="search" disabled autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"></div><button type="button" class="help-button">?</button>
                <a id="settings-menu" href="../../../settings.html"><img src="../../../wheel.svg" width="18" height="18" alt="Change settings"></a></div></form></nav><section id="main" class="content"><h1 class="fqn"><span class="in-band">Module <a href="../../index.html">smoldot</a>::<wbr><a href="../index.html">sync</a>::<wbr><a class="mod" href="">all_forks</a></span><span class="out-of-band"><span id="render-detail"><a id="toggle-all-docs" href="javascript:void(0)" title="collapse all docs">[<span class="inner">&#x2212;</span>]</a></span><a class="srclink" href="../../../src/smoldot/sync/all_forks.rs.html#18-1173" title="goto source code">[src]</a></span></h1><div class="docblock"><p><em>All-forks</em> header and body syncing.</p>
<h1 id="overview" class="section-header"><a href="#overview">Overview</a></h1>
<p>This state machine holds:</p>
<ul>
<li>A list of sources of blocks, maintained by the API user.</li>
<li>For each source, a list of blocks hashes known by the source.</li>
<li>The latest known finalized block.</li>
<li>A tree of valid non-finalized blocks that all descend from the latest known finalized block.</li>
<li>(if full mode) A list of block headers whose body is currently being downloaded.</li>
<li>A list of block header waiting to be verified and whose ancestry with the latest finalized
block is currently unknown.</li>
</ul>
<p>The state machine has the objective to synchronize the tree of non-finalized blocks with its
equivalent on the sources added by the API user.</p>
<p>Because it is not possible to predict which block in this tree is going to be finalized in
the future, the entire tree needs to be synchronized.</p>
<blockquote>
<p><strong>Example</strong>: If the latest finalized block is block number 4, and the tree contains blocks
5, 6, and 7, and a source announces a block 5 that is different from the
locally-known block 5, a block request will be emitted for this block 5, even
if it is certain that this “other” block 5 will not become the local best
block. This is necessary in case it is this other block 5 that will end up
being finalized.</p>
</blockquote>
<h1 id="full-vs-non-full" class="section-header"><a href="#full-vs-non-full">Full vs non-full</a></h1>
<p>The <a href="../../../smoldot/sync/all_forks/struct.Config.html#structfield.full" title="Config::full"><code>Config::full</code></a> option configures whether the state machine only holds headers of the
non-finalized blocks (<code>full</code> equal to <code>false</code>), or the headers, and bodies, and storage
(<code>full</code> equal to <code>true</code>).</p>
<p>In full mode, .</p>
<h1 id="bounded-and-unbounded-containers" class="section-header"><a href="#bounded-and-unbounded-containers">Bounded and unbounded containers</a></h1>
<p>It is important to limit the memory usage of this state machine no matter how the
potentially-malicious sources behave.</p>
<p>The state in this state machine can be put into three categories:</p>
<ul>
<li>
<p>Each source of blocks has a certain fixed-size state associated to it (containing for
instance its best block number and height). Each source also has up to one in-flight
request, which might incur more memory usage. Managing this additional request is out of
scope of this module. The user of this module is expected to limit the number of
simultaneous sources.</p>
</li>
<li>
<p>A set of verified blocks that descend from the latest finalized block. This set is
unbounded. The consensus and finalization algorithms of the chain are supposed to limit
the number of possible blocks in this set.</p>
</li>
<li>
<p>A set of blocks that can’t be verified yet. Receiving a block announce inserts an element
in this set. In order to handle situations where a malicious source announces lots of
invalid blocks, this set must be bounded. Once it has reached a certain size, the blocks
with the highest block number are discarded if their parent is also in this set or being
downloaded from a source.</p>
</li>
</ul>
<p>Consequently, and assuming that the number of simultaneous sources is bounded, and that
the consensus and finalization algorithms of the chain are properly configured, malicious
sources can’t indefinitely grow the state in this state machine.
Malicious sources, however, can potentially increase the number of block requests required to
download a long fork. This is, at most, an annoyance, and not a vulnerability.</p>
</div><h2 id="structs" class="section-header"><a href="#structs">Structs</a></h2>
<table><tr class="module-item"><td><a class="struct" href="struct.AllForksSync.html" title="smoldot::sync::all_forks::AllForksSync struct">AllForksSync</a></td><td class="docblock-short"></td></tr><tr class="module-item"><td><a class="struct" href="struct.Config.html" title="smoldot::sync::all_forks::Config struct">Config</a></td><td class="docblock-short"><p>Configuration for the <a href="../../../smoldot/sync/all_forks/struct.AllForksSync.html" title="AllForksSync"><code>AllForksSync</code></a>.</p>
</td></tr><tr class="module-item"><td><a class="struct" href="struct.HeaderVerify.html" title="smoldot::sync::all_forks::HeaderVerify struct">HeaderVerify</a></td><td class="docblock-short"><p>Header verification to be performed.</p>
</td></tr><tr class="module-item"><td><a class="struct" href="struct.RequestId.html" title="smoldot::sync::all_forks::RequestId struct">RequestId</a></td><td class="docblock-short"><p>Identifier for a request in the [<code>PendingBlocks</code>].</p>
</td></tr><tr class="module-item"><td><a class="struct" href="struct.RequestParams.html" title="smoldot::sync::all_forks::RequestParams struct">RequestParams</a></td><td class="docblock-short"><p>Information about a blocks request to be performed on a source.</p>
</td></tr><tr class="module-item"><td><a class="struct" href="struct.RequestSuccessBlock.html" title="smoldot::sync::all_forks::RequestSuccessBlock struct">RequestSuccessBlock</a></td><td class="docblock-short"><p>Struct to pass back when a block request has succeeded.</p>
</td></tr><tr class="module-item"><td><a class="struct" href="struct.SourceId.html" title="smoldot::sync::all_forks::SourceId struct">SourceId</a></td><td class="docblock-short"><p>Identifier for a source in the [<code>AllForksSources</code>].</p>
</td></tr></table><h2 id="enums" class="section-header"><a href="#enums">Enums</a></h2>
<table><tr class="module-item"><td><a class="enum" href="enum.AncestrySearchResponseOutcome.html" title="smoldot::sync::all_forks::AncestrySearchResponseOutcome enum">AncestrySearchResponseOutcome</a></td><td class="docblock-short"><p>Outcome of calling <a href="../../../smoldot/sync/all_forks/struct.AllForksSync.html#method.finish_ancestry_search" title="AllForksSync::finish_ancestry_search"><code>AllForksSync::finish_ancestry_search</code></a>.</p>
</td></tr><tr class="module-item"><td><a class="enum" href="enum.BlockAnnounceOutcome.html" title="smoldot::sync::all_forks::BlockAnnounceOutcome enum">BlockAnnounceOutcome</a></td><td class="docblock-short"><p>Outcome of calling <a href="../../../smoldot/sync/all_forks/struct.AllForksSync.html#method.block_announce" title="AllForksSync::block_announce"><code>AllForksSync::block_announce</code></a>.</p>
</td></tr><tr class="module-item"><td><a class="enum" href="enum.BlockBodyVerify.html" title="smoldot::sync::all_forks::BlockBodyVerify enum">BlockBodyVerify</a></td><td class="docblock-short"><p>State of the processing of blocks.</p>
</td></tr><tr class="module-item"><td><a class="enum" href="enum.HeaderVerifyError.html" title="smoldot::sync::all_forks::HeaderVerifyError enum">HeaderVerifyError</a></td><td class="docblock-short"><p>Error that can happen when verifying a block header.</p>
</td></tr><tr class="module-item"><td><a class="enum" href="enum.HeaderVerifyOutcome.html" title="smoldot::sync::all_forks::HeaderVerifyOutcome enum">HeaderVerifyOutcome</a></td><td class="docblock-short"><p>Outcome of calling <a href="../../../smoldot/sync/all_forks/struct.HeaderVerify.html#method.perform" title="HeaderVerify::perform"><code>HeaderVerify::perform</code></a>.</p>
</td></tr><tr class="module-item"><td><a class="enum" href="enum.JustificationVerification.html" title="smoldot::sync::all_forks::JustificationVerification enum">JustificationVerification</a></td><td class="docblock-short"><p>Information about the verification of a justification that was stored for this block.</p>
</td></tr><tr class="module-item"><td><a class="enum" href="enum.ProcessOne.html" title="smoldot::sync::all_forks::ProcessOne enum">ProcessOne</a></td><td class="docblock-short"><p>State of the processing of blocks.</p>
</td></tr></table></section><section id="search" class="content hidden"></section><section class="footer"></section><div id="rustdoc-vars" data-root-path="../../../" data-current-crate="smoldot" data-search-js="../../../search-index.js"></div>
    <script src="../../../main.js"></script></body></html>